<!DOCTYPE html>
<html lang="zh-CN" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>知识库周报 (2025.5.12-5.25) - 可视化报告</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <style>
        /* Custom scrollbar for webkit browsers */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #555;
        }
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #777;
        }

        /* Fade-in animation */
        .fade-in-section, .fade-in-item {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.6s ease-out, transform 0.6s ease-out;
        }
        .fade-in-section.is-visible, .fade-in-item.is-visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* Card styling */
        .report-card, .task-card, .portfolio-card, .insight-list-card { 
            background-color: white;
            border: 1px solid #e5e7eb; 
            border-radius: 0.75rem; 
            transition: box-shadow 0.3s ease, border-color 0.3s ease, transform 0.2s ease;
        }
        .dark .report-card, .dark .task-card, .dark .portfolio-card, .dark .insight-list-card {
            background-color: #1f2937; 
            border-color: #4b5563; 
        }
        .report-card:hover, .task-card:hover, .portfolio-card:hover, .insight-list-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); 
            border-color: #9ca3af; 
            transform: translateY(-2px) scale(1.01);
        }
        .dark .report-card:hover, .dark .task-card:hover, .dark .portfolio-card:hover, .dark .insight-list-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1); 
            border-color: #6b7280; 
        }
        
        .competitor-insight-item, .other-insight-progress-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem; 
            background-color: #f9fafb; 
            border-radius: 0.5rem; 
            margin-bottom: 0.5rem; 
            transition: background-color 0.2s ease;
        }
        .dark .competitor-insight-item, .dark .other-insight-progress-item {
            background-color: #374151; 
        }
        .competitor-insight-item:hover, .other-insight-progress-item:hover {
            background-color: #f3f4f6; 
        }
        .dark .competitor-insight-item:hover, .dark .other-insight-progress-item:hover {
            background-color: #4b5563;
        }

        .theme-toggle-button {
            background-color: #f3f4f6; 
            color: #374151; 
            transition: background-color 0.2s ease, color 0.2s ease, transform 0.1s ease;
        }
        .dark .theme-toggle-button {
            background-color: #374151; 
            color: #f3f4f6; 
        }
        .theme-toggle-button:hover {
            background-color: #e5e7eb; 
            transform: scale(1.05);
        }
        .dark .theme-toggle-button:hover {
            background-color: #4b5563; 
        }

        .bar {
            background-color: #ccc; 
            border-radius: 0.25rem 0.25rem 0 0; 
        }
        .stacked-bar-segment { 
            transition: width 0.5s ease-in-out;
            text-align: center;
            color: white;
            font-size: 0.875rem; 
            line-height: 1.75rem; 
            overflow: hidden;
            white-space: nowrap;
        }
        
        .custom-table th, .custom-table td {
            border-width: 1px;
            padding: 0.75rem;
        }
        .custom-table th {
            background-color: #f9fafb;
        }
        .dark .custom-table th {
            background-color: #374151;
        }
        .custom-table {
            border-color: #e5e7eb;
        }
        .dark .custom-table {
            border-color: #4b5563;
        }

        .task-card .task-status, #portfolio-content .task-status, .insight-item-status {
            font-size: 0.875rem; 
            padding: 0.375rem 0.75rem; 
            border-radius: 9999px; 
            font-weight: 500; 
            display: inline-flex; 
            align-items: center;
            cursor: pointer; 
        }
        .task-card .card-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .status-maintenance { background-color: #eff6ff; color: #3b82f6; border: 1px solid #bfdbfe; }
        .dark .status-maintenance { background-color: #1e3a8a; color: #93c5fd; border: 1px solid #3b82f6; }
        .status-output { background-color: #f0fdf4; color: #16a34a; border: 1px solid #bbf7d0; }
        .dark .status-output { background-color: #14532d; color: #86efac; border: 1px solid #22c55e; }
        .status-triggered { background-color: #fffbeb; color: #ca8a04; border: 1px solid #fde68a; }
        .dark .status-triggered { background-color: #713f12; color: #facc15; border: 1px solid #eab308; }
        .status-goal { background-color: #fdf2f8; color: #db2777; border: 1px solid #fbcfe8; }
        .dark .status-goal { background-color: #831843; color: #f9a8d4; border: 1px solid #ec4899; }
        
        body {
            font-family: 'Inter', sans-serif; 
            font-size: 1rem; 
        }
        
         #portfolio-content table thead th { 
            text-transform: uppercase;
            letter-spacing: wider;
            vertical-align: middle;
            padding-top: 0.75rem; 
            padding-bottom: 0.75rem; 
        }
         #portfolio-content table thead th > div { 
            margin-bottom: 0.125rem;
         }

        #portfolio-content tbody tr:hover, #portfolio-content .card-item:hover {
            background-color: rgba(0, 0, 0, 0.03);
        }
        .dark #portfolio-content tbody tr:hover, .dark #portfolio-content .card-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in-card { animation: fadeIn 0.5s ease-out forwards; }

        .progress-list-scrollable::-webkit-scrollbar { width: 6px; }
        .progress-list-scrollable::-webkit-scrollbar-thumb { background: #9ca3af; } 
        .dark .progress-list-scrollable::-webkit-scrollbar-thumb { background: #6b7280; }

        .okr-tag {
            display: inline-block; background-color: #e0e7ff; color: #4338ca;
            font-size: 0.875rem; 
            font-weight: 500; padding: 0.375rem 0.875rem; 
            border-radius: 9999px; margin-top: 0.25rem; line-height: 1.5;
        }
        .dark .okr-tag { background-color: #3730a3; color: #c7d2fe; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex; align-items: center; justify-content: center;
            z-index: 1000; opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content {
            background-color: white; padding: 2rem; border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            width: 90%; max-width: 600px; 
            transform: scale(0.95); transition: transform 0.3s ease;
        }
        .modal-overlay.active .modal-content { transform: scale(1); }
        .dark .modal-content { background-color: #1f2937; } 

        .add-progress-btn, .add-insight-btn { 
            background-color: #e5e7eb; 
            color: #4b5563; 
            width: 1.75rem; 
            height: 1.75rem; 
            border-radius: 9999px;
            display: inline-flex; align-items: center; justify-content: center;
            transition: background-color 0.2s ease, transform 0.2s ease;
            margin-left: 0.5rem; 
        }
        .add-progress-btn:hover, .add-insight-btn:hover {
            background-color: #d1d5db; 
            transform: scale(1.05);
        }
        .dark .add-progress-btn, .dark .add-insight-btn {
            background-color: #374151; 
            color: #d1d5db; 
        }
        .dark .add-progress-btn:hover, .dark .add-insight-btn:hover {
            background-color: #4b5563; 
        }
        .add-progress-btn i, .add-insight-btn i { font-size: 0.75rem; } 

        @keyframes fadeInItem { 
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeInItem { animation: fadeInItem 0.3s ease-out; }

        .column-chart-container {
            display: flex;
            justify-content: space-around;
            align-items: flex-end; 
            height: 120px; 
            gap: 0.5rem; 
            margin-top: 0.75rem; 
            padding: 0 0.5rem; 
        }
        .chart-column {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex-grow: 1; 
            max-width: 30%; 
        }
        .column-chart-container .bar { 
            width: 60%; 
            transition: height 0.3s ease-in-out; 
            position: relative; 
        }
        .bar-label {
            font-size: 0.875rem; 
            margin-top: 0.25rem;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            text-align: center;
        }
        .bar-label-text {
            font-size: 0.75rem; 
            margin-top: 0.125rem;
            color: #6b7280; 
        }
        .dark .bar-label-text {
            color: #9ca3af; 
        }


        .status-inprogress-color { background-color: #f59e0b; } 
        .status-completed-color { background-color: #10b981; } 
        .status-pending-color { background-color: #6366f1; } 

        .dark .status-inprogress-color { background-color: #d97706; } 
        .dark .status-completed-color { background-color: #059669; } 
        .dark .status-pending-color { background-color: #4f46e5; } 
        
        .text-status-inprogress { color: #f59e0b !important; }
        .text-status-completed { color: #10b981 !important; }
        .text-status-pending { color: #6366f1 !important; }

        .dark .text-status-inprogress { color: #fbbf24 !important; }
        .dark .text-status-completed { color: #34d399 !important; }
        .dark .text-status-pending { color: #818cf8 !important; }
        
        .status-badge.inprogress { background-color: #fef3c7; color: #b45309; }
        .dark .status-badge.inprogress { background-color: #78350f; color: #fde68a; }

        .status-badge.completed { background-color: #d1fae5; color: #047857; }
        .dark .status-badge.completed { background-color: #065f46; color: #a7f3d0; }

        .status-badge.pending { background-color: #e0e7ff; color: #3730a3; }
        .dark .status-badge.pending { background-color: #3730a3; color: #c7d2fe; }

        .delete-insight-btn {
            background: none;
            border: none;
            color: #9ca3af; 
            cursor: pointer;
            padding: 0.25rem;
            margin-left: 0.5rem;
        }
        .delete-insight-btn:hover {
            color: #ef4444; 
        }
        .dark .delete-insight-btn {
            color: #6b7280; 
        }
        .dark .delete-insight-btn:hover {
            color: #f87171; 
        }
        
        .dynamic-island-light-shadow { 
             box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.03);
        }
        .dark .dynamic-island-light-shadow { 
             box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.07);
        }
        .card-shadow { 
             box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .dark .card-shadow {
             box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.15), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
        }
        .new-chart-container { 
            position: relative;
            margin: auto;
            height: 500px; 
            width: 100%;
        }
        #appCategoryDataFormModal .grid { 
            gap: 0.75rem; 
        }
        #appCategoryDataFormModal label {
            font-size: 0.875rem; 
        }
        #appCategoryDataFormModal input[type="number"] {
            font-size: 0.875rem; 
            padding: 0.5rem;
        }


        @media (max-width: 768px) {
            .new-chart-container {
                height: 420px;
            }
            #dynamic-island-stats .text-xl { 
                font-size: 1.25rem; 
            }
             #dynamic-island-stats .text-xs { 
                font-size: 0.75rem; 
            }
            #dynamic-island h1.title-font-unified { 
                font-size: 1.25rem !important; 
            }
            .app-analysis-subtitle { 
                font-size: 0.875rem; 
            }
            .app-analysis-subtitle i {
                font-size: 0.8em;
            }
        }
        @media (max-width: 480px) {
            .new-chart-container {
                height: 450px; 
            }
            #dynamic-island h1.title-font-unified { 
                font-size: 1.25rem !important; 
            }
            .app-analysis-subtitle {
                font-size: 0.875rem; 
            }
        }

    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'primary-light': '#3b82f6',
                        'primary-dark': '#60a5fa',
                        'accent-light': '#10b981',
                        'accent-dark': '#34d399',
                        'bg-light': '#f9fafb', 
                        'bg-dark': '#111827',   
                        'card-light': '#ffffff',
                        'card-dark': '#1f2937', 
                        'text-light-primary': '#1f2937', 
                        'text-light-secondary': '#6b7280',
                        'text-dark-primary': '#f3f4f6', 
                        'text-dark-secondary': '#9ca3af',
                        'border-border-light': '#e5e7eb', 
                        'border-border-dark': '#4b5563',   
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    animation: {
                        fadeInUp: 'fadeInUp 0.6s ease-out forwards',
                        fadeIn: 'fadeIn 0.5s ease-out forwards' 
                    },
                    keyframes: {
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        fadeIn: { 
                            '0%': { opacity: '0', transform: 'translateY(5px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
        (function() {
            const theme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (theme === 'dark' || (!theme && prefersDark)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        })();
    </script>
</head>
<body class="bg-bg-light dark:bg-bg-dark text-text-light-primary dark:text-dark-primary font-sans antialiased text-base">

    <header class="sticky top-0 z-50 bg-card-light/80 dark:bg-card-dark/80 backdrop-blur-md shadow-sm">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <h1 contenteditable="true" class="text-2xl sm:text-3xl font-bold text-primary-light dark:text-primary-dark focus:outline-none focus:ring-2 focus:ring-primary-light dark:focus:ring-primary-dark px-2 rounded-md">
                    <i class="fas fa-chart-line mr-2"></i>知识库周报 (2025.5.12-5.25)
                </h1>
                <button id="theme-toggle" onclick="toggleTheme()" title="切换深色/浅色模式"
                        class="theme-toggle-button p-2 rounded-full focus:outline-none focus:ring-2 focus:ring-primary-light dark:focus:ring-primary-dark">
                    <i id="moon-icon" class="fas fa-moon text-lg"></i>
                    <i id="sun-icon" class="fas fa-sun text-lg" style="display:none;"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 sm:p-6 lg:p-8">
        
        <section id="overview" class="mb-12 fade-in-section">
            <h2 class="text-2xl sm:text-3xl font-semibold mb-2 text-text-light-primary dark:text-dark-primary flex items-center">
                <i class="fas fa-tachometer-alt mr-3 text-accent-light dark:text-accent-dark"></i>洞察成果归档概览
            </h2>
            <p class="text-base text-text-light-secondary dark:text-dark-secondary mb-6 fade-in-item"> 
                共232份报告和Excel表格：竞品洞察58个，APP洞察156个，人群洞察3个，专题洞察11个，国家洞察2个，语言洞察 2个。
            </p>
            <div id="archival-content-wrapper">
                </div>
        </section>

        <section id="competitor-insights" class="mb-12 fade-in-section">
            <h2 class="text-2xl sm:text-3xl font-semibold mb-6 text-text-light-primary dark:text-dark-primary flex items-center">
                <i class="fas fa-microscope mr-3 text-accent-light dark:text-accent-dark"></i>01 竞品洞察
            </h2>
            <div class="report-card p-6">
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="text-xl font-semibold text-text-light-primary dark:text-dark-primary"> 
                            <i class="fas fa-calendar-plus mr-2 text-blue-500"></i>本周新增
                        </h4>
                        <button onclick="openAddCompetitorInsightModal()" class="add-insight-btn" aria-label="添加竞品洞察">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div id="new-competitor-insights-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        </div>
                </div>
                <h3 class="text-xl font-semibold mb-4 text-text-light-primary dark:text-dark-primary">具体成果统计 (按竞品)</h3> 
                <div id="competitor-table-wrapper">
                    </div>
            </div>
        </section>

        <section id="app-insights" class="mb-12 fade-in-section">
            <h2 class="text-2xl sm:text-3xl font-semibold mb-6 text-text-light-primary dark:text-dark-primary flex items-center">
                <i class="fas fa-mobile-alt mr-3 text-accent-light dark:text-accent-dark"></i>02 APP洞察分析
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-1 gap-6">
                <div class="report-card p-6"> 
                    <h3 class="text-xl font-semibold mb-3 text-text-light-primary dark:text-dark-primary">OKR</h3> 
                    <div id="app-tasks-wrapper">
                        </div>
                </div>

                <div class="report-card p-0 overflow-hidden">
                     <section id="dynamic-island" class="p-6 md:p-8 bg-card-light dark:bg-card-dark text-text-light-primary dark:text-dark-primary rounded-xl dynamic-island-light-shadow dark:dynamic-island-dark-shadow flex flex-col items-center space-y-5 md:space-y-6">
                        <h1 class="text-xl font-semibold text-text-light-primary dark:text-dark-primary order-first title-font-unified">APP标签刷新进展</h1> 
                        <div id="dynamic-island-stats" class="w-full flex flex-col sm:flex-row justify-around items-center space-y-5 sm:space-y-0 sm:space-x-2">
                            <div class="flex items-center space-x-3 transform hover:scale-105 transition-transform duration-200">
                                <i class="fas fa-tags text-sky-500 text-xl md:text-2xl"></i>
                                <div>
                                    <div class="text-sm text-text-light-secondary dark:text-dark-secondary uppercase tracking-wider mb-1 font-medium">已标注</div> 
                                    <div class="text-2xl md:text-3xl font-bold text-text-light-primary dark:text-dark-primary">7193</div> 
                                </div>
                            </div>
                            <div class="h-10 w-px bg-border-light dark:bg-border-dark hidden sm:block"></div>
                            <div class="flex items-center space-x-3 transform hover:scale-105 transition-transform duration-200">
                                <i class="fas fa-clipboard-list text-amber-500 text-xl md:text-2xl"></i>
                                <div>
                                    <div class="text-sm text-text-light-secondary dark:text-dark-secondary uppercase tracking-wider mb-1 font-medium">未标注</div> 
                                    <div class="text-2xl md:text-3xl font-bold text-text-light-primary dark:text-dark-primary">3669</div> 
                                </div>
                            </div>
                            <div class="h-10 w-px bg-border-light dark:bg-border-dark hidden sm:block"></div>
                            <div class="flex items-center space-x-3 transform hover:scale-105 transition-transform duration-200">
                                <i class="fas fa-chart-line text-sky-500 text-xl md:text-2xl"></i> 
                                <div>
                                    <div class="text-sm text-text-light-secondary dark:text-dark-secondary uppercase tracking-wider mb-1 font-medium">月活数据</div> 
                                    <div class="text-lg md:text-xl font-semibold text-sky-700 dark:text-sky-300 px-3 py-1 bg-sky-100 dark:bg-sky-800/50 rounded-full">未刷新</div> 
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
                <div class="report-card p-0 overflow-hidden">
                    <main class="p-5 md:p-8 bg-card-light dark:bg-card-dark rounded-xl card-shadow"> 
                        <section> 
                            <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-6">
                                <h2 class="text-xl font-semibold text-text-light-primary dark:text-dark-primary mb-3 sm:mb-0">应用场景分析</h2> 
                                <div class="app-analysis-subtitle bg-sky-100/70 text-sky-800 dark:bg-sky-800/30 dark:text-sky-200 text-base font-semibold px-3 py-1.5 rounded-lg inline-flex items-center space-x-2 self-center sm:self-auto"> 
                                    <i class="fas fa-microscope text-sky-600 dark:text-sky-400"></i>
                                    <span>共分析 157 个 APP</span>
                                </div>
                            </div>
                            <div class="mb-6">
                                <button id="openEditAppCategoryChartModalBtn" onclick="openEditAppCategoryChartModal()" class="px-4 py-2 bg-indigo-500 text-white rounded-md hover:bg-indigo-600 transition-colors text-sm font-medium">
                                    <i class="fas fa-edit mr-2"></i>编辑图表数据
                                </button>
                            </div>
                            <div class="new-chart-container">
                                <canvas id="appCategoryChart"></canvas>
                            </div>
                        </section>
                    </main>
                </div>
                </div>
        </section>

        <section id="other-insights" class="mb-12 fade-in-section">
             <h2 class="text-2xl sm:text-3xl font-semibold mb-6 text-text-light-primary dark:text-dark-primary flex items-center">
                <i class="fas fa-cubes mr-3 text-accent-light dark:text-accent-dark"></i>其他洞察类别
            </h2>
            <div class="grid grid-cols-1 gap-6">

                <div id="crowd-insight-card" class="fade-in-card report-card p-6 flex flex-col dynamic-island-light-shadow">
                    <h2 class="text-xl font-semibold text-text-light-primary dark:text-dark-primary mb-4 flex items-center"> 
                        <i class="fas fa-users mr-3 text-lg text-sky-500"></i>人群洞察
                    </h2>
                    <div class="mb-5">
                        <h3 class="text-base font-medium text-text-light-secondary dark:text-dark-secondary mb-1 flex items-center"> 
                            <i class="fas fa-bullseye mr-2 text-gray-400 dark:text-gray-500"></i>OKR
                        </h3>
                        <span class="okr-tag">例行维护（目标完成TOP5重点国家画像分析）</span>
                    </div>
                    <div class="flex-grow">
                        <div class="flex items-center mb-2">
                            <h3 class="text-base font-medium text-text-light-secondary dark:text-dark-secondary flex items-center"> 
                                <i class="fas fa-tasks mr-2 text-gray-400 dark:text-gray-500"></i>本周进度
                            </h3>
                            <button onclick="openProgressModal('crowd')" class="add-progress-btn" aria-label="添加人群洞察进度">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div class="md:flex md:gap-6">
                            <div class="md:w-1/3 mb-4 md:mb-0">
                                <div id="progress-chart-crowd" class="h-full flex flex-col justify-center">
                                    </div>
                            </div>
                            <div class="md:w-2/3">
                                <ul class="space-y-2 mb-3 max-h-48 overflow-y-auto progress-list-scrollable" id="progress-list-crowd">
                                    </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="special-insight-card" class="fade-in-card report-card p-6 flex flex-col dynamic-island-light-shadow">
                    <h2 class="text-xl font-semibold text-text-light-primary dark:text-dark-primary mb-4 flex items-center"> 
                        <i class="fas fa-lightbulb mr-3 text-lg text-amber-500"></i>专题洞察
                    </h2>
                    <div class="mb-5">
                        <h3 class="text-base font-medium text-text-light-secondary dark:text-dark-secondary mb-1 flex items-center"> 
                            <i class="fas fa-bullseye mr-2 text-gray-400 dark:text-gray-500"></i>OKR
                        </h3>
                        <span class="okr-tag">T+7天初版报告输出</span> <span class="okr-tag">T+14天深度报告输出</span>
                    </div>
                    <div class="flex-grow">
                        <div class="flex items-center mb-2">
                            <h3 class="text-base font-medium text-text-light-secondary dark:text-dark-secondary flex items-center"> 
                                <i class="fas fa-tasks mr-2 text-gray-400 dark:text-gray-500"></i>本周进度
                            </h3>
                            <button onclick="openProgressModal('special')" class="add-progress-btn" aria-label="添加专题洞察进度">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div class="md:flex md:gap-6">
                            <div class="md:w-1/3 mb-4 md:mb-0">
                                <div id="progress-chart-special" class="h-full flex flex-col justify-center">
                                    </div>
                            </div>
                            <div class="md:w-2/3">
                                <ul class="space-y-2.5 mb-3 max-h-48 overflow-y-auto progress-list-scrollable" id="progress-list-special">
                                    </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="country-insight-card" class="fade-in-card report-card p-6 flex flex-col dynamic-island-light-shadow">
                    <h2 class="text-xl font-semibold text-text-light-primary dark:text-dark-primary mb-4 flex items-center"> 
                        <i class="fas fa-globe-americas mr-3 text-lg text-emerald-500"></i>国家洞察
                    </h2>
                    <div class="mb-5">
                        <h3 class="text-base font-medium text-text-light-secondary dark:text-dark-secondary mb-1 flex items-center"> 
                            <i class="fas fa-bullseye mr-2 text-gray-400 dark:text-gray-500"></i>OKR
                        </h3>
                        <span class="okr-tag">T+3月完成（目标完成TOP3国家洞察报告）</span>
                    </div>
                    <div class="flex-grow">
                        <div class="flex items-center mb-2">
                            <h3 class="text-base font-medium text-text-light-secondary dark:text-dark-secondary flex items-center"> 
                                <i class="fas fa-tasks mr-2 text-gray-400 dark:text-gray-500"></i>本周进度
                            </h3>
                            <button onclick="openProgressModal('country')" class="add-progress-btn" aria-label="添加国家洞察进度">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div class="md:flex md:gap-6">
                            <div class="md:w-1/3 mb-4 md:mb-0">
                                <div id="progress-chart-country" class="h-full flex flex-col justify-center">
                                    </div>
                            </div>
                            <div class="md:w-2/3">
                                <ul class="space-y-2.5 mb-3 max-h-48 overflow-y-auto progress-list-scrollable" id="progress-list-country">
                                    </ul>
                            </div>
                        </div>
                    </div>
                </div>

                 <div id="operator-insight-card" class="fade-in-card report-card p-6 flex flex-col dynamic-island-light-shadow">
                    <h2 class="text-xl font-semibold text-text-light-primary dark:text-dark-primary mb-4 flex items-center"> 
                        <i class="fas fa-broadcast-tower mr-3 text-lg text-purple-500"></i>运营商洞察
                    </h2>
                    <div class="mb-5">
                        <h3 class="text-base font-medium text-text-light-secondary dark:text-dark-secondary mb-1 flex items-center"> 
                            <i class="fas fa-bullseye mr-2 text-gray-400 dark:text-gray-500"></i>OKR
                        </h3>
                        <span class="okr-tag">议题触发</span>
                    </div>
                    <div class="flex-grow">
                        <div class="flex items-center mb-2">
                            <h3 class="text-base font-medium text-text-light-secondary dark:text-dark-secondary flex items-center"> 
                                <i class="fas fa-tasks mr-2 text-gray-400 dark:text-gray-500"></i>本周进度
                            </h3>
                            <button onclick="openProgressModal('operator')" class="add-progress-btn" aria-label="添加运营商洞察进度">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div class="md:flex md:gap-6">
                            <div class="md:w-1/3 mb-4 md:mb-0">
                                <div id="progress-chart-operator" class="h-full flex flex-col justify-center">
                                    </div>
                            </div>
                            <div class="md:w-2/3">
                                <ul class="space-y-2.5 mb-3 max-h-48 overflow-y-auto progress-list-scrollable" id="progress-list-operator">
                                    </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="language-insight-card" class="fade-in-card report-card p-6 flex flex-col dynamic-island-light-shadow">
                    <h2 class="text-xl font-semibold text-text-light-primary dark:text-dark-primary mb-4 flex items-center"> 
                        <i class="fas fa-language mr-3 text-lg text-teal-500"></i>语言洞察
                    </h2>
                    <div class="mb-5">
                        <h3 class="text-base font-medium text-text-light-secondary dark:text-dark-secondary mb-1 flex items-center"> 
                            <i class="fas fa-bullseye mr-2 text-gray-400 dark:text-gray-500"></i>OKR
                        </h3>
                        <span class="okr-tag">半年刷新国家&语种规则</span>
                    </div>
                     <div class="flex-grow">
                        <div class="flex items-center mb-2">
                            <h3 class="text-base font-medium text-text-light-secondary dark:text-dark-secondary flex items-center"> 
                                <i class="fas fa-tasks mr-2 text-gray-400 dark:text-gray-500"></i>本周进度
                            </h3>
                            <button onclick="openProgressModal('language')" class="add-progress-btn" aria-label="添加语言洞察进度">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div class="md:flex md:gap-6">
                            <div class="md:w-1/3 mb-4 md:mb-0">
                                <div id="progress-chart-language" class="h-full flex flex-col justify-center">
                                    </div>
                            </div>
                            <div class="md:w-2/3">
                                <ul class="space-y-2.5 mb-3 max-h-48 overflow-y-auto progress-list-scrollable" id="progress-list-language">
                                     </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <div id="progressModal" class="modal-overlay">
        <div class="modal-content dark:bg-slate-800"> <h3 class="text-lg font-semibold mb-4 text-text-light-primary dark:text-dark-primary" id="modalTitle">添加新进度</h3>
            <form id="addProgressForm">
                <div class="mb-4">
                    <label for="itemName" class="block text-base font-medium text-text-light-secondary dark:text-dark-secondary mb-1">名称</label> 
                    <input type="text" id="itemName" name="itemName" required class="w-full p-2 border border-border-light dark:border-border-dark rounded-md text-base bg-card-light dark:bg-slate-700 focus:ring-primary-light dark:focus:ring-primary-dark text-text-light-primary dark:text-dark-primary"> 
                </div>
                <div class="mb-4">
                    <label for="itemType" class="block text-base font-medium text-text-light-secondary dark:text-dark-secondary mb-1">类型</label> 
                    <select id="itemType" name="itemType" class="w-full p-2 border border-border-light dark:border-border-dark rounded-md text-base bg-card-light dark:bg-slate-700 focus:ring-primary-light dark:focus:ring-primary-dark text-text-light-primary dark:text-dark-primary"> 
                        <option value="ppt">PPT</option>
                        <option value="excel">Excel</option>
                        <option value="other">其他</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="itemUrl" class="block text-base font-medium text-text-light-secondary dark:text-dark-secondary mb-1">网页链接 (可选)</label>
                    <input type="url" id="itemUrl" name="itemUrl" placeholder="https://example.com" class="w-full p-2 border border-border-light dark:border-border-dark rounded-md text-base bg-card-light dark:bg-slate-700 focus:ring-primary-light dark:focus:ring-primary-dark text-text-light-primary dark:text-dark-primary">
                </div>
                <div class="mb-6">
                    <label for="itemStatus" class="block text-base font-medium text-text-light-secondary dark:text-dark-secondary mb-1">状态</label> 
                    <select id="itemStatus" name="itemStatus" class="w-full p-2 border border-border-light dark:border-border-dark rounded-md text-base bg-card-light dark:bg-slate-700 focus:ring-primary-light dark:focus:ring-primary-dark text-text-light-primary dark:text-dark-primary"> 
                        <option value="inprogress">进行中</option>
                        <option value="completed">已完成</option>
                        <option value="pending">待开始</option>
                    </select>
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" onclick="closeProgressModal()" class="px-4 py-2 text-base font-medium text-text-light-primary dark:text-dark-primary bg-gray-100 dark:bg-gray-600 hover:bg-gray-200 dark:hover:bg-gray-500 rounded-md transition-colors">取消</button> 
                    <button type="submit" class="inline-flex items-center justify-center px-4 py-2 text-base font-medium text-white bg-blue-500 hover:bg-blue-600 dark:bg-blue-600 dark:hover:bg-blue-700 rounded-md transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:focus:ring-offset-slate-800">确认添加</button> 
                </div>
            </form>
        </div>
    </div>

    <div id="addCompetitorInsightModal" class="modal-overlay">
        <div class="modal-content dark:bg-slate-800">
            <h3 class="text-lg font-semibold mb-4 text-text-light-primary dark:text-dark-primary" id="competitorInsightModalTitle">添加竞品洞察 (本周新增)</h3>
            <form id="addCompetitorInsightForm">
                <div class="mb-4">
                    <label for="competitorInsightName" class="block text-base font-medium text-text-light-secondary dark:text-dark-secondary mb-1">名称 (含负责人)</label> 
                    <input type="text" id="competitorInsightName" name="competitorInsightName" required class="w-full p-2 border border-border-light dark:border-border-dark rounded-md text-base bg-card-light dark:bg-slate-700 focus:ring-primary-light dark:focus:ring-primary-dark text-text-light-primary dark:text-dark-primary"> 
                </div>
                <div class="mb-4">
                    <label for="competitorInsightType" class="block text-base font-medium text-text-light-secondary dark:text-dark-secondary mb-1">类型</label> 
                    <select id="competitorInsightType" name="competitorInsightType" class="w-full p-2 border border-border-light dark:border-border-dark rounded-md text-base bg-card-light dark:bg-slate-700 focus:ring-primary-light dark:focus:ring-primary-dark text-text-light-primary dark:text-dark-primary"> 
                        <option value="ppt">PPT</option>
                        <option value="excel">Excel</option>
                        <option value="other">其他</option>
                    </select>
                </div>
                <div class="mb-6">
                    <label for="competitorInsightStatus" class="block text-base font-medium text-text-light-secondary dark:text-dark-secondary mb-1">状态</label> 
                    <select id="competitorInsightStatus" name="competitorInsightStatus" class="w-full p-2 border border-border-light dark:border-border-dark rounded-md text-base bg-card-light dark:bg-slate-700 focus:ring-primary-light dark:focus:ring-primary-dark text-text-light-primary dark:text-dark-primary"> 
                        <option value="completed">已完成</option>
                        <option value="inprogress">进行中</option>
                        <option value="pending">待开始</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="competitorInsightUrl" class="block text-base font-medium text-text-light-secondary dark:text-dark-secondary mb-1">网页链接 (可选)</label> 
                    <input type="url" id="competitorInsightUrl" name="competitorInsightUrl" placeholder="https://example.com" class="w-full p-2 border border-border-light dark:border-border-dark rounded-md text-base bg-card-light dark:bg-slate-700 focus:ring-primary-light dark:focus:ring-primary-dark text-text-light-primary dark:text-dark-primary"> 
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" onclick="closeAddCompetitorInsightModal()" class="px-4 py-2 text-base font-medium text-text-light-primary dark:text-dark-primary bg-gray-100 dark:bg-gray-600 hover:bg-gray-200 dark:hover:bg-gray-500 rounded-md transition-colors">取消</button> 
                    <button type="submit" class="inline-flex items-center justify-center px-4 py-2 text-base font-medium text-white bg-blue-500 hover:bg-blue-600 dark:bg-blue-600 dark:hover:bg-blue-700 rounded-md transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:focus:ring-offset-slate-800">确认添加</button> 
                </div>
            </form>
        </div>
    </div>

    <div id="editAppCategoryChartModal" class="modal-overlay">
        <div class="modal-content dark:bg-slate-800">
            <h3 class="text-xl font-semibold mb-6 text-text-light-primary dark:text-dark-primary">编辑应用场景分析数据</h3>
            <div id="appCategoryDataFormContainerModal" class="mb-6 p-4 border border-border-light dark:border-border-dark rounded-lg bg-gray-50 dark:bg-gray-800/30 max-h-[60vh] overflow-y-auto">
                <form id="appCategoryDataFormModal" class="space-y-3"></form>
            </div>
            <div class="flex justify-end gap-3">
                <button type="button" onclick="closeEditAppCategoryChartModal()" class="px-4 py-2 text-base font-medium text-text-light-primary dark:text-dark-primary bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 rounded-md transition-colors">取消</button>
                <button id="updateAppCategoryChartFromModalBtn" class="px-4 py-2 text-base font-medium text-white bg-blue-500 hover:bg-blue-600 dark:bg-blue-600 dark:hover:bg-blue-700 rounded-md transition-colors">更新图表</button>
            </div>
        </div>
    </div>


    <footer class="py-8 text-center text-base text-text-light-secondary dark:text-dark-secondary border-t border-border-light dark:border-border-dark"> 
        <p>&copy; <span id="currentYear">2025</span> 知识库洞察团队。保留所有权利。</p>
        <p class="text-sm mt-1">可视化报告由AI生成并整合</p> 
    </footer>

    <script id="script-成果归档">
        const insightsData_archival = [
            { name: "APP洞察", value: 156, colorClass: "bg-[#1F3864]", icon: "fas fa-mobile-alt", hexColor: "#1F3864" },
            { name: "竞品洞察", value: 58, colorClass: "bg-[#2E5291]", icon: "fas fa-crosshairs", hexColor: "#2E5291" },
            { name: "专题洞察", value: 11, colorClass: "bg-[#4F75C2]", icon: "fas fa-lightbulb", hexColor: "#4F75C2" },
            { name: "人群洞察", value: 3, colorClass: "bg-[#7898D8]", icon: "fas fa-users", hexColor: "#7898D8" },
            { name: "国家洞察", value: 2, colorClass: "bg-[#A7C0EC]", icon: "fas fa-globe-americas", hexColor: "#A7C0EC" },
            { name: "语言洞察", value: 2, colorClass: "bg-[#C9D9F4]", icon: "fas fa-language", hexColor: "#C9D9F4" }
        ];
        const totalArchives_archival = 232;

        function createDonutChart_archival(data, totalValue, containerSelector) {
            const container = document.querySelector(containerSelector);
            if (!container) {
                console.error(`Donut chart container ${containerSelector} not found.`);
                return;
            }
            container.innerHTML = ''; 

            const chartSize = Math.min(container.offsetWidth * 0.95, container.offsetHeight * 0.95, 280);
            
            if (chartSize <= 0) {
                console.error(`Donut chart for ${containerSelector} has zero or negative size.`);
                container.innerHTML = '<p class="text-sm text-red-500 dark:text-red-400 p-2 text-center">图表因尺寸为零无法绘制</p>';
                return;
            }
            
            const svgNS = "http://www.w3.org/2000/svg";
            const svg = document.createElementNS(svgNS, "svg");
            const strokeWidth = chartSize * 0.18;
            const radius = (chartSize / 2) - (strokeWidth / 2);
            const centerX = chartSize / 2;
            const centerY = chartSize / 2;

            svg.setAttribute("viewBox", `0 0 ${chartSize} ${chartSize}`);
            svg.setAttribute("width", "100%");
            svg.setAttribute("height", "100%");
            svg.setAttribute("style", `max-width: ${chartSize}px; max-height: ${chartSize}px; margin: auto;`);

            let accumulatedAngle = -90;

            data.forEach((item) => {
                const percentage = item.value / totalValue;
                const angleSweep = percentage * 360;

                const startRad = (Math.PI / 180) * accumulatedAngle;
                const endRad = (Math.PI / 180) * (accumulatedAngle + angleSweep);
                const startX = centerX + radius * Math.cos(startRad);
                const startY = centerY + radius * Math.sin(startRad);
                const endX = centerX + radius * Math.cos(endRad);
                const endY = centerY + radius * Math.sin(endRad);
                const largeArcFlag = angleSweep > 180 ? 1 : 0;
                const d = [`M ${startX} ${startY}`, `A ${radius} ${radius} 0 ${largeArcFlag} 1 ${endX} ${endY}`].join(" ");

                const arc = document.createElementNS(svgNS, "path");
                arc.setAttribute("d", d);
                arc.setAttribute("fill", "none");
                arc.setAttribute("stroke", item.hexColor);
                arc.setAttribute("stroke-width", strokeWidth);
                svg.appendChild(arc);

                const percentageLabelValue = Math.round(percentage * 100);
                if (percentageLabelValue >= 3) {
                    const labelAngle = accumulatedAngle + angleSweep / 2;
                    const labelRadius = radius;
                    const lx = centerX + labelRadius * Math.cos((Math.PI / 180) * labelAngle);
                    const ly = centerY + labelRadius * Math.sin((Math.PI / 180) * labelAngle);

                    const percText = document.createElementNS(svgNS, "text");
                    percText.setAttribute("x", lx);
                    percText.setAttribute("y", ly);
                    percText.setAttribute("text-anchor", "middle");
                    percText.setAttribute("dominant-baseline", "middle");
                    percText.setAttribute("fill", "#ffffff");
                    percText.setAttribute("font-size", chartSize * 0.06); 
                    percText.setAttribute("font-weight", "bold");
                    percText.textContent = percentageLabelValue + "%";
                    svg.appendChild(percText);
                }
                accumulatedAngle += angleSweep;
            });

            const text = document.createElementNS(svgNS, "text");
            text.setAttribute("x", "50%");
            text.setAttribute("y", "50%");
            text.setAttribute("dy", "0.35em");
            text.setAttribute("text-anchor", "middle");
            text.setAttribute("font-size", chartSize * 0.24); 
            text.setAttribute("font-weight", "bold");
            
            const isDark = document.documentElement.classList.contains('dark');
            let primaryTextColor = '#1f2937'; 
            if (isDark) {
                primaryTextColor = '#f3f4f6'; 
            }
            if (window.tailwind && window.tailwind.config && window.tailwind.config.theme && window.tailwind.config.theme.extend && window.tailwind.config.theme.extend.colors) {
                const colors = window.tailwind.config.theme.extend.colors;
                primaryTextColor = isDark ? (colors['text-dark-primary'] || '#f3f4f6') : (colors['text-light-primary'] || '#1f2937');
            }
            text.setAttribute("fill", primaryTextColor);
            text.textContent = totalValue;
            svg.appendChild(text);
            container.appendChild(svg);
        }

        function createBarCharts_archival(data, containerSelector) {
            const container = document.querySelector(containerSelector);
            if (!container) {
                console.error(`Bar chart container ${containerSelector} not found.`);
                return;
            }
            container.innerHTML = '';
            const maxValue = Math.max(...data.map(item => item.value));
            const baseBarHeightClass = "h-5 md:h-6"; 
            let availableBarSpace = 200;
            if (container.offsetWidth > 0) {
                if (container.offsetWidth > 600) availableBarSpace = container.offsetWidth * 0.5;
                else if (container.offsetWidth > 400) availableBarSpace = container.offsetWidth * 0.4;
                else availableBarSpace = container.offsetWidth * 0.5; 
            } else {
                 availableBarSpace = 150; 
            }

            const maxBarPixelWidth = Math.min(300, availableBarSpace);

            if (maxBarPixelWidth <= 0 && data.some(item => item.value > 0)) {
                 console.error(`Bar chart for ${containerSelector} has zero or negative bar width. maxBarPixelWidth: ${maxBarPixelWidth}`);
                 container.innerHTML = '<p class="text-sm text-red-500 dark:text-red-400 p-2 text-center">图表因宽度为零无法绘制</p>';
                 return;
            }

            data.forEach((item, index) => {
                const barWidth = item.value > 0 ? Math.max(10, (item.value / maxValue) * maxBarPixelWidth) : 0;
                
                const linkWrapper = document.createElement('a');
                let targetId = '';
                switch (item.name) {
                    case "APP洞察": targetId = "#app-insights"; break;
                    case "竞品洞察": targetId = "#competitor-insights"; break;
                    case "专题洞察": targetId = "#special-insight-card"; break;
                    case "人群洞察": targetId = "#crowd-insight-card"; break;
                    case "国家洞察": targetId = "#country-insight-card"; break;
                    case "语言洞察": targetId = "#language-insight-card"; break;
                    default: targetId = "#other-insights"; 
                }
                linkWrapper.href = targetId;
                linkWrapper.className = "block p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700/30 transition-all duration-200 transform hover:scale-[1.015]"; 

                const innerDiv = document.createElement('div');
                innerDiv.className = "flex items-center space-x-2"; 

                const iconContainer = document.createElement('div');
                iconContainer.className = `w-10 h-10 md:w-11 md:h-11 flex items-center justify-center rounded-lg ${item.colorClass} text-white shadow-sm flex-shrink-0`; 
                const iconEl = document.createElement('i');
                iconEl.className = `${item.icon} text-lg md:text-xl`; 
                iconContainer.appendChild(iconEl);
                innerDiv.appendChild(iconContainer);

                const nameSpan = document.createElement('span');
                nameSpan.className = "w-40 text-base md:text-lg font-medium text-text-light-primary dark:text-dark-primary truncate flex-shrink-0"; 
                nameSpan.textContent = item.name;
                nameSpan.title = item.name;
                innerDiv.appendChild(nameSpan);

                const valueBarWrapper = document.createElement('div');
                valueBarWrapper.className = "flex-grow flex items-center space-x-2";
                const barDiv = document.createElement('div');
                barDiv.className = `${baseBarHeightClass} rounded-full ${item.colorClass}`; 
                barDiv.style.width = `${barWidth}px`; 
                const valueSpan = document.createElement('span');
                valueSpan.className = "font-semibold text-sm md:text-base text-text-light-primary dark:text-dark-primary w-12 text-right flex-shrink-0"; 
                valueSpan.textContent = String(item.value);

                valueBarWrapper.appendChild(barDiv);
                valueBarWrapper.appendChild(valueSpan);
                innerDiv.appendChild(valueBarWrapper);
                
                linkWrapper.appendChild(innerDiv);
                container.appendChild(linkWrapper);
            });
        }
        
        function drawArchivalCharts() {
            const archivalContentWrapper = document.getElementById('archival-content-wrapper');
            if (archivalContentWrapper) {
                archivalContentWrapper.innerHTML = `
                    <main class="grid grid-cols-1 lg:grid-cols-3 gap-6 md:gap-8">
                        <section class="lg:col-span-1 report-card p-6 shadow-lg fade-in-item">
                            <h2 class="text-xl font-semibold mb-1 text-text-light-primary dark:text-dark-primary text-center">总体归档</h2>
                            <p class="text-center text-sm text-text-light-secondary dark:text-dark-secondary mb-4">各项洞察总览</p>
                            <div id="donut-chart-container-archival" class="relative w-full h-64 md:h-72 lg:h-80 flex items-center justify-center"></div>
                        </section>
                        <section class="lg:col-span-2 report-card p-6 shadow-lg fade-in-item" style="transition-delay: 0.1s;">
                            <h2 class="text-xl font-semibold mb-1 text-text-light-primary dark:text-dark-primary">分类洞察</h2>
                            <p class="text-sm text-text-light-secondary dark:text-dark-secondary mb-6">各项洞察详细数据</p>
                            <div id="bar-charts-container-archival" class="space-y-4"></div>
                        </section>
                    </main>
                `;
                
                requestAnimationFrame(() => { 
                    requestAnimationFrame(() => { 
                        if (document.getElementById('donut-chart-container-archival') && document.getElementById('bar-charts-container-archival')) {
                             createDonutChart_archival(insightsData_archival, totalArchives_archival, '#donut-chart-container-archival');
                             createBarCharts_archival(insightsData_archival, '#bar-charts-container-archival');
                        } else {
                            console.error("Chart containers not found even after double rAF in drawArchivalCharts.");
                        }

                        const newFadeInItems = archivalContentWrapper.querySelectorAll('.fade-in-item');
                        const newObserver = new IntersectionObserver((entries) => {
                            entries.forEach((entry, idx) => {
                                if (entry.isIntersecting) {
                                    if (!entry.target.style.transitionDelay) {
                                        entry.target.style.transitionDelay = `${idx * 100}ms`;
                                    }
                                    entry.target.classList.add('is-visible');
                                    newObserver.unobserve(entry.target);
                                }
                            });
                        }, { threshold: 0.1 });
                        newFadeInItems.forEach(item => newObserver.observe(item));
                    });
                });
            } else {
                 console.error("archival-content-wrapper not found in drawArchivalCharts.");
            }
        }
    </script>

    <script id="script-竞品洞察表格">
        const columnDefinitions_competitorTable = [
            { key: 'competitor', label: '竞品', status: '', statusShort: '', statusPillClass: '' },
            { key: 'googleCompetitiveRelationship', label: '谷歌竞合关系', status: '例行维护', statusShort: '例行维护', statusPillClass: 'status-maintenance' },
            { key: 'osFeatures', label: 'OS特性', status: '发布T+2天输出', statusShort: 'T+2输出', statusPillClass: 'status-output' },
            { key: 'aiFeatures', label: 'AI特性', status: '发布T+2天输出', statusShort: 'T+2输出', statusPillClass: 'status-output' },
            { key: 'scenarioDomainFeatures', label: '场景垂域特性', status: '例行维护', statusShort: '例行维护', statusPillClass: 'status-maintenance' },
            { key: 'keyBusinessEvolutionTrends', label: '关键业务演进趋势', status: '议题触发', statusShort: '议题触发', statusPillClass: 'status-triggered' },
            { key: 'localizationPath', label: '竞品本地化之路', status: '例行维护', statusShort: '例行维护', statusPillClass: 'status-maintenance' },
            { key: 'dynamicsJournal', label: '竞品动态期刊', status: '双周发布', statusShort: '双周发布', statusPillClass: 'status-output' },
            { key: 'valueProposition', label: '价值阵地推荐', status: '例行维护 (目标完成各竞品5个阵地分析)', statusShort: '例行维护(目标)', statusPillClass: 'status-goal' }
        ];

        const portfolioData_competitorTable = [
            { competitor: "谷歌", googleCompetitiveRelationship: { excel: 1, pptPdf: 2 }, osFeatures: { excel: 2, pptPdf: 5 }, aiFeatures: { excel: 3, pptPdf: 0 }, scenarioDomainFeatures: { excel: 0, pptPdf: 0 }, keyBusinessEvolutionTrends: { excel: 0, pptPdf: 3 }, localizationPath: { excel: 0, pptPdf: 1 }, dynamicsJournal: { excel: 1, pptPdf: 0 }, valueProposition: { excel: 0, pptPdf: 1 } },
            { competitor: "三星", googleCompetitiveRelationship: { excel: 0, pptPdf: 0 }, osFeatures: { excel: 0, pptPdf: 7 }, aiFeatures: { excel: 0, pptPdf: 0 }, scenarioDomainFeatures: { excel: 1, pptPdf: 8 }, keyBusinessEvolutionTrends: { excel: 0, pptPdf: 0 }, localizationPath: { excel: 0, pptPdf: 1 }, dynamicsJournal: { excel: 1, pptPdf: 0 }, valueProposition: { excel: 0, pptPdf: 1 } },
            { competitor: "苹果", googleCompetitiveRelationship: { excel: 0, pptPdf: 0 }, osFeatures: { excel: 0, pptPdf: 4 }, aiFeatures: { excel: 0, pptPdf: 0 }, scenarioDomainFeatures: { excel: 0, pptPdf: 0 }, keyBusinessEvolutionTrends: { excel: 0, pptPdf: 1 }, localizationPath: { excel: 0, pptPdf: 0 }, dynamicsJournal: { excel: 1, pptPdf: 0 }, valueProposition: { excel: 0, pptPdf: 1 } },
            { competitor: "传音", googleCompetitiveRelationship: { excel: 0, pptPdf: 0 }, osFeatures: { excel: 0, pptPdf: 0 }, aiFeatures: { excel: 0, pptPdf: 0 }, scenarioDomainFeatures: { excel: 0, pptPdf: 0 }, keyBusinessEvolutionTrends: { excel: 0, pptPdf: 0 }, localizationPath: { excel: 0, pptPdf: 1 }, dynamicsJournal: { excel: 0, pptPdf: 0 }, valueProposition: { excel: 0, pptPdf: 0 } },
            { competitor: "VIVO", googleCompetitiveRelationship: { excel: 0, pptPdf: 0 }, osFeatures: { excel: 0, pptPdf: 0 }, aiFeatures: { excel: 0, pptPdf: 1 }, scenarioDomainFeatures: { excel: 0, pptPdf: 0 }, keyBusinessEvolutionTrends: { excel: 0, pptPdf: 0 }, localizationPath: { excel: 0, pptPdf: 1 }, dynamicsJournal: { excel: 1, pptPdf: 0 }, valueProposition: { excel: 0, pptPdf: 0 } },
            { competitor: "honor", googleCompetitiveRelationship: { excel: 0, pptPdf: 0 }, osFeatures: { excel: 0, pptPdf: 0 }, aiFeatures: { excel: 0, pptPdf: 1 }, scenarioDomainFeatures: { excel: 0, pptPdf: 0 }, keyBusinessEvolutionTrends: { excel: 0, pptPdf: 0 }, localizationPath: { excel: 0, pptPdf: 0 }, dynamicsJournal: { excel: 0, pptPdf: 0 }, valueProposition: { excel: 0, pptPdf: 0 } },
            { competitor: "Xiaomi", googleCompetitiveRelationship: { excel: 1, pptPdf: 0 }, osFeatures: { excel: 0, pptPdf: 1 }, aiFeatures: { excel: 0, pptPdf: 1 }, scenarioDomainFeatures: { excel: 0, pptPdf: 0 }, keyBusinessEvolutionTrends: { excel: 0, pptPdf: 0 }, localizationPath: { excel: 0, pptPdf: 0 }, dynamicsJournal: { excel: 1, pptPdf: 0 }, valueProposition: { excel: 0, pptPdf: 0 } },
            { competitor: "OPPO", googleCompetitiveRelationship: { excel: 0, pptPdf: 0 }, osFeatures: { excel: 0, pptPdf: 0 }, aiFeatures: { excel: 0, pptPdf: 1 }, scenarioDomainFeatures: { excel: 0, pptPdf: 0 }, keyBusinessEvolutionTrends: { excel: 0, pptPdf: 0 }, localizationPath: { excel: 0, pptPdf: 1 }, dynamicsJournal: { excel: 1, pptPdf: 0 }, valueProposition: { excel: 0, pptPdf: 0 } },
        ];
        

        function createFileCountHtml_competitorTable(data) {
            if (!data || (data.excel === 0 && data.pptPdf === 0)) return '<span class="text-text-light-secondary dark:text-dark-secondary">-</span>';
            let html = '<div class="flex items-center space-x-1 justify-center">'; 
            if (data.excel > 0) html += `<span class="inline-flex items-center px-1.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-700 dark:text-green-100"><i class="fas fa-file-excel mr-1"></i>Excel:${data.excel}</span>`; 
            if (data.pptPdf > 0) html += `<span class="inline-flex items-center px-1.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-700 dark:text-blue-100"><i class="fas fa-file-lines mr-1"></i>PPT:${data.pptPdf}</span>`; 
            html += '</div>';
            return html;
        }

        function renderCompetitorPortfolio() {
            const tableWrapper = document.getElementById('competitor-table-wrapper');
            if (tableWrapper) {
                const mainHtml = `
                <main id="portfolio-content" class="fade-in-item">
                    <div class="hidden md:block bg-card-light dark:bg-card-dark rounded-lg overflow-hidden border border-border-light dark:border-border-dark">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-border-light dark:divide-border-dark table-fixed">
                                <colgroup>
                                    <col style="width: 8%;"> 
                                    <col style="width: 11.5%;"> 
                                    <col style="width: 11.5%;"> 
                                    <col style="width: 11.5%;"> 
                                    <col style="width: 11.5%;"> 
                                    <col style="width: 11.5%;"> 
                                    <col style="width: 11.5%;"> 
                                    <col style="width: 11.5%;"> 
                                    <col style="width: 11.5%;"> 
                                </colgroup>
                                <thead class="bg-gray-50 dark:bg-gray-800/50">
                                    <tr>
                                        <th rowspan="2" class="px-2 py-2 text-left text-sm font-bold text-black dark:text-gray-200 align-middle border-l border-r border-border-light dark:border-border-dark whitespace-normal">竞品</th> 
                                        <th colspan="5" class="px-2 py-2 text-center text-sm font-bold text-black dark:text-gray-200 align-middle border-l border-r border-border-light dark:border-border-dark whitespace-normal">竞品OS</th> 
                                        ${columnDefinitions_competitorTable.filter(cd => ['localizationPath', 'dynamicsJournal', 'valueProposition'].includes(cd.key)).map(colDef => `
                                            <th rowspan="2" class="px-2 py-2 text-center text-sm font-semibold text-text-light-secondary dark:text-dark-secondary align-middle border-l border-r border-border-light dark:border-border-dark whitespace-normal"> 
                                                <div>${colDef.label}</div>
                                                ${colDef.statusShort ? `<span class="task-status ${colDef.statusPillClass} text-[9px] px-1.5 py-0.5 mt-0.5 inline-block">${colDef.statusShort}</span>` : ''} 
                                            </th>
                                        `).join('')}
                                    </tr>
                                    <tr>
                                        ${columnDefinitions_competitorTable.slice(1, 6).map(colDef => `
                                            <th class="px-2 py-2 text-center text-sm font-semibold text-text-light-secondary dark:text-dark-secondary align-middle border-l border-r border-border-light dark:border-border-dark whitespace-normal"> 
                                                <div>${colDef.label}</div>
                                                ${colDef.statusShort ? `<span class="task-status ${colDef.statusPillClass} text-[9px] px-1.5 py-0.5 mt-0.5 inline-block">${colDef.statusShort}</span>` : ''} 
                                            </th>
                                        `).join('')}
                                    </tr>
                                </thead>
                                <tbody id="portfolio-table-body-embedded" class="bg-card-light dark:bg-card-dark divide-y divide-border-light dark:divide-border-dark">
                                    ${portfolioData_competitorTable.map(item => `
                                        <tr class="transition-colors duration-150">
                                            <td class="px-2 py-2 whitespace-normal text-xs font-medium text-text-light-primary dark:text-dark-primary border-l border-r border-border-light dark:border-border-dark">${item.competitor}</td> 
                                            ${columnDefinitions_competitorTable.slice(1).map(colDef => {
                                                let cellClasses = "px-2 py-2 whitespace-normal text-xs text-center border-r border-border-light dark:border-border-dark"; 
                                                if (colDef.key === 'googleCompetitiveRelationship' || ['localizationPath', 'dynamicsJournal', 'valueProposition'].includes(colDef.key)) { 
                                                    cellClasses += " border-l"; 
                                                }
                                                return `<td class="${cellClasses}">${createFileCountHtml_competitorTable(item[colDef.key])}</td>`;
                                            }).join('')}
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div id="portfolio-cards-container-embedded" class="md:hidden grid grid-cols-1 sm:grid-cols-2 gap-6 mt-6">
                        ${portfolioData_competitorTable.map((item, index) => `
                            <div class="portfolio-card bg-card-light dark:bg-card-dark p-6 rounded-xl shadow-lg border border-border-light dark:border-border-dark transition-all duration-300 ease-in-out fade-in-item" style="transition-delay: ${index * 100}ms;">
                                <h3 class="text-lg font-semibold mb-4 text-primary-light dark:text-primary-dark">${item.competitor}</h3> 
                                <div class="space-y-3">
                                ${columnDefinitions_competitorTable.slice(1).map(colDef => {
                                    let contentHtml = createFileCountHtml_competitorTable(item[colDef.key]);
                                    let cellClasses = "text-sm text-center";  
                                    if (item[colDef.key] && (item[colDef.key].excel > 0 || item[colDef.key].pptPdf > 0)) {
                                        return `<div class="card-item py-2 border-b border-border-light dark:border-border-dark last:border-b-0 transition-colors duration-150">
                                                    <p class="text-sm font-medium text-text-light-secondary dark:text-dark-secondary mb-1 text-center">${colDef.label}</p> 
                                                    <div class="${cellClasses}">${contentHtml}</div>
                                                </div>`;
                                    } return '';
                                }).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </main>
                `;
                tableWrapper.innerHTML = mainHtml;
                const newFadeInItems = tableWrapper.querySelectorAll('.fade-in-item');
                const newObserver = new IntersectionObserver((entries) => {
                    entries.forEach((entry) => {
                        if (entry.isIntersecting) {
                            entry.target.classList.add('is-visible');
                            newObserver.unobserve(entry.target);
                        }
                    });
                }, { threshold: 0.1 });
                newFadeInItems.forEach(item => newObserver.observe(item));
            }
        }
    </script>

    <script id="script-APP洞察分要求">
        function renderAppTaskRequirements() {
            const appTasksWrapper = document.getElementById('app-tasks-wrapper');
            if (appTasksWrapper) {
                appTasksWrapper.innerHTML = `
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 py-4 fade-in-item">
                        <div class="task-card p-5">
                            <div class="flex items-start">
                                <div class="flex-shrink-0 w-10 h-10 bg-sky-100 dark:bg-sky-800/30 rounded-full flex items-center justify-center mr-3">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-sky-600 dark:text-sky-400">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 6.375c0 2.278-3.694 4.125-8.25 4.125S3.75 8.653 3.75 6.375m16.5 0c0-2.278-3.694-4.125-8.25-4.125S3.75 4.097 3.75 6.375m16.5 0v11.25c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125V6.375m16.5 0v3.75m-16.5-3.75v3.75m16.5 0v3.75C20.25 16.153 16.556 18 12 18s-8.25-1.847-8.25-4.125v-3.75m16.5 0c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125" />
                                    </svg>
                                </div>
                                <div class="flex-grow">
                                    <h2 class="text-lg font-semibold text-text-light-primary dark:text-dark-primary">数据标签＆月活数据刷新</h2> 
                                    <div class="mt-1 space-y-1">
                                        <span class="inline-block bg-sky-100 text-sky-700 dark:bg-sky-700 dark:text-sky-100 text-sm font-medium px-2.5 py-1 rounded-full">季度刷新</span> 
                                        <span class="inline-block bg-purple-100 text-purple-700 dark:bg-purple-700 dark:text-purple-100 text-sm font-medium px-2.5 py-1 rounded-full">目标：TOP 3000 APP</span> 
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="task-card p-5">
                            <div class="flex items-start">
                                <div class="flex-shrink-0 w-10 h-10 bg-emerald-100 dark:bg-emerald-800/30 rounded-full flex items-center justify-center mr-3">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-emerald-600 dark:text-emerald-400">
                                         <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h3.75c.621 0 1.125.504 1.125 1.125v6.75c0 .621-.504 1.125-1.125 1.125h-3.75A1.125 1.125 0 0 1 3 21v-7.875M3 13.125c0-6.075 4.925-11 11-11h.5c.621 0 1.125.504 1.125 1.125v.007c0 .621-.504 1.125-1.125 1.125h-.5A9.875 9.875 0 0 0 5.125 13.125M15 13.125c0-3.038-2.462-5.5-5.5-5.5S4 10.087 4 13.125m11 0v6.75c0 .621.504 1.125 1.125 1.125h3.75c.621 0 1.125-.504 1.125-1.125V13.125c0-1.657-1.343-3-3-3h-1.5a3 3 0 0 0-3 3Z" />
                                    </svg>
                                </div>
                                <div class="flex-grow">
                                    <h2 class="text-lg font-semibold text-text-light-primary dark:text-dark-primary">APP洞察报告</h2> 
                                    <div class="mt-1 space-y-1">
                                        <span class="inline-block bg-emerald-100 text-emerald-700 dark:bg-emerald-700 dark:text-emerald-100 text-sm font-medium px-2.5 py-1 rounded-full">例行维护</span> 
                                        <span class="inline-block bg-purple-100 text-purple-700 dark:bg-purple-700 dark:text-purple-100 text-sm font-medium px-2.5 py-1 rounded-full">目标：TOP 200 APP</span> 
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                const newFadeInItems = appTasksWrapper.querySelectorAll('.fade-in-item');
                const newObserver = new IntersectionObserver((entries) => {
                    entries.forEach((entry) => {
                        if (entry.isIntersecting) {
                            entry.target.classList.add('is-visible');
                            newObserver.unobserve(entry.target);
                        }
                    });
                }, { threshold: 0.1 });
                newFadeInItems.forEach(item => newObserver.observe(item));
            }
        }
    </script>
    
    <script id="new-app-category-chart-script">
        let appCategoryChartInstance = null; 
        
        let currentChartData = { 
            categories: [
                "社交场景", "影音娱乐", "购物场景", "生活场景", "出行场景", 
                "办公场景", "工具场景", "金融场景", "医疗健康", "美食场景", 
                "学习教育", "AI场景"
            ],
            completedTotal: [16, 47, 10, 2, 15, 27, 10, 12, 3, 2, 9, 4], 
            newThisWeek: [0, 4, 0, 0, 2, 0, 3, 0, 0, 0, 1, 0]
        };

        function createAppCategoryDataInputsInModal() {
            const form = document.getElementById('appCategoryDataFormModal');
            if (!form) return;
            form.innerHTML = ''; 

            currentChartData.categories.forEach((category, index) => {
                const prevCompleted = currentChartData.completedTotal[index] - currentChartData.newThisWeek[index];
                const newThisWeekVal = currentChartData.newThisWeek[index];

                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'grid grid-cols-3 items-center gap-2 mb-2'; 

                const label = document.createElement('label');
                label.textContent = category;
                label.className = 'text-sm text-text-light-secondary dark:text-dark-secondary col-span-1';
                categoryDiv.appendChild(label);

                const prevInputDiv = document.createElement('div');
                prevInputDiv.className = 'col-span-1';
                const prevInput = document.createElement('input');
                prevInput.type = 'number';
                prevInput.id = `modal-category-${index}-prev`;
                prevInput.value = prevCompleted;
                prevInput.min = "0";
                prevInput.className = 'w-full p-1.5 border border-border-light dark:border-border-dark rounded-md text-sm bg-card-light dark:bg-slate-700 focus:ring-primary-light dark:focus:ring-primary-dark text-text-light-primary dark:text-dark-primary';
                prevInputDiv.appendChild(prevInput);
                categoryDiv.appendChild(prevInputDiv);
                
                const newWeekInputDiv = document.createElement('div');
                newWeekInputDiv.className = 'col-span-1';
                const newWeekInput = document.createElement('input');
                newWeekInput.type = 'number';
                newWeekInput.id = `modal-category-${index}-new`;
                newWeekInput.value = newThisWeekVal;
                newWeekInput.min = "0";
                newWeekInput.className = 'w-full p-1.5 border border-border-light dark:border-border-dark rounded-md text-sm bg-card-light dark:bg-slate-700 focus:ring-primary-light dark:focus:ring-primary-dark text-text-light-primary dark:text-dark-primary';
                newWeekInputDiv.appendChild(newWeekInput);
                categoryDiv.appendChild(newWeekInputDiv);

                form.appendChild(categoryDiv);
            });
            const headerDiv = document.createElement('div');
            headerDiv.className = 'grid grid-cols-3 items-center gap-2 mb-1 font-medium text-sm text-text-light-primary dark:text-dark-primary';
            headerDiv.innerHTML = `
                <span class="col-span-1">场景</span>
                <span class="col-span-1 text-center">之前完成</span>
                <span class="col-span-1 text-center">本周新增</span>
            `;
            form.insertBefore(headerDiv, form.firstChild);
        }


        function renderAppCategoryChart(dataToRender) {
            const ctx = document.getElementById('appCategoryChart')?.getContext('2d');
            if (!ctx) {
                console.warn("App Category Chart canvas context not found.");
                return;
            }

            if (appCategoryChartInstance) {
                appCategoryChartInstance.destroy();
            }
            
            const appData = dataToRender || currentChartData; 

            const combinedData = appData.categories.map((category, index) => ({
                category: category,
                completedTotal: appData.completedTotal[index],
                newThisWeek: appData.newThisWeek[index],
                overallTotal: appData.completedTotal[index] 
            }));

            combinedData.sort((a, b) => b.overallTotal - a.overallTotal);

            const sortedAppData = {
                categories: combinedData.map(item => item.category),
                completedTotal: combinedData.map(item => item.completedTotal),
                newThisWeek: combinedData.map(item => item.newThisWeek)
            };
            
            const previouslyCompletedSorted = sortedAppData.completedTotal.map((total, index) => {
                const categoryName = sortedAppData.categories[index];
                const originalIndex = appData.categories.indexOf(categoryName); 
                return total - appData.newThisWeek[originalIndex];
            });
             const newThisWeekSorted = sortedAppData.categories.map(categoryName => {
                const originalIndex = appData.categories.indexOf(categoryName);
                return appData.newThisWeek[originalIndex];
            });


            const isDark = document.documentElement.classList.contains('dark');
            
            let gridColor = 'rgba(203, 213, 225, 0.5)'; 
            let yTickColor = isDark ? '#9ca3af' : '#6b7280'; 
            let legendLabelColor = '#1f2937'; 
            let tooltipBgColor = 'rgba(0, 0, 0, 0.85)';
            let tooltipTitleColor = '#ffffff';
            let tooltipBodyColor = '#ffffff';
            let datalabelsNewThisWeekColor = '#000000';
            let barPreviouslyCompletedBg = 'rgba(59, 130, 246, 0.85)'; 
            let barNewThisWeekBg = 'rgba(245, 158, 11, 0.85)'; 

            if (isDark) {
                gridColor = 'rgba(100, 116, 139, 0.3)'; 
                legendLabelColor = '#f3f4f6'; 
                tooltipBgColor = 'rgba(30, 41, 59, 0.9)'; 
                tooltipTitleColor = '#f1f5f9'; 
                tooltipBodyColor = '#e2e8f0'; 
                datalabelsNewThisWeekColor = '#E2E8F0';
                barPreviouslyCompletedBg = 'rgba(96, 165, 250, 0.7)'; 
                barNewThisWeekBg = 'rgba(251, 191, 36, 0.7)'; 
            }
            
            const themeColors = (window.tailwind && window.tailwind.config && window.tailwind.config.theme && 
                                window.tailwind.config.theme.extend && window.tailwind.config.theme.extend.colors) 
                                ? window.tailwind.config.theme.extend.colors 
                                : null;

            if (themeColors) {
                yTickColor = isDark ? (themeColors['text-dark-secondary'] || yTickColor) : (themeColors['text-light-secondary'] || yTickColor);
                legendLabelColor = isDark ? (themeColors['text-dark-primary'] || legendLabelColor) : (themeColors['text-light-primary'] || legendLabelColor);
            } else {
                console.warn("Tailwind theme colors not fully available for chart. Using fallbacks.");
            }


            appCategoryChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedAppData.categories,
                    datasets: [
                        {
                            label: '之前完成', 
                            data: previouslyCompletedSorted,
                            backgroundColor: barPreviouslyCompletedBg, 
                            borderWidth: 0,
                            borderRadius: { bottomLeft: 6, bottomRight: 6, topLeft: 0, topRight: 0 },
                            barPercentage: 0.65, 
                            categoryPercentage: 0.7,
                            datalabels: {
                                color: '#ffffff', 
                                anchor: 'center',
                                align: 'center',
                                font: { weight: 'bold', size: 11, family: "'Inter', sans-serif" }, 
                                formatter: (value) => value > 0 ? value : ''
                            }
                        },
                        {
                            label: '本周新增', 
                            data: newThisWeekSorted, 
                            backgroundColor: barNewThisWeekBg, 
                            borderWidth: 0,
                            borderRadius: { topLeft: 6, topRight: 6, bottomLeft: 0, bottomRight: 0 },
                            barPercentage: 0.65,
                            categoryPercentage: 0.7,
                            datalabels: {
                                color: datalabelsNewThisWeekColor, 
                                anchor: 'center',
                                align: 'center',
                                font: { 
                                    weight: 'bold', 
                                    size: 11,  
                                    family: "'Inter', sans-serif" 
                                },
                                formatter: (value) => value > 0 ? value : ''
                            }
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'x', 
                    scales: {
                        x: { 
                            stacked: true, 
                            grid: { display: false }, 
                            ticks: { 
                                color: legendLabelColor, 
                                font: { family: "'Inter', 'PingFang SC', 'Microsoft YaHei', sans-serif", size: 14, weight: 'bold' }, 
                                maxRotation: 45, 
                                minRotation: 25
                            }
                        },
                        y: { 
                            stacked: true, 
                            beginAtZero: true,
                            grid: { color: gridColor },
                            ticks: { color: yTickColor, font: { family: "'Inter', sans-serif", size: 13 } } 
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: legendLabelColor, 
                                font: { family: "'Inter', 'PingFang SC', 'Microsoft YaHei', sans-serif", size: 14 }, 
                                usePointStyle: true,
                                boxWidth: 10,
                            }
                        },
                        tooltip: {
                            backgroundColor: tooltipBgColor,
                            titleFont: { family: "'Inter', 'PingFang SC', 'Microsoft YaHei', sans-serif", size: 15, weight: 'bold' }, 
                            bodyFont: { family: "'Inter', 'PingFang SC', 'Microsoft YaHei', sans-serif", size: 13 }, 
                            titleColor: tooltipTitleColor, 
                            bodyColor: tooltipBodyColor,  
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) { label += ': '; }
                                    if (context.parsed.y !== null) { label += context.parsed.y; } 
                                    return label;
                                },
                                footer: function(tooltipItems) {
                                    let sum = 0;
                                    tooltipItems.forEach(function(tooltipItem) { sum += tooltipItem.parsed.y; }); 
                                    return '总计: ' + sum;
                                }
                            }
                        }
                    },
                    interaction: { mode: 'index', axis: 'x', intersect: false, }, 
                    animation: { duration: 1000, easing: 'easeInOutQuart' }
                }
            });
        }
        
        const editAppCategoryChartModal = document.getElementById('editAppCategoryChartModal');

        function openEditAppCategoryChartModal() {
            createAppCategoryDataInputsInModal(); 
            if(editAppCategoryChartModal) editAppCategoryChartModal.classList.add('active');
        }

        function closeEditAppCategoryChartModal() {
            if(editAppCategoryChartModal) editAppCategoryChartModal.classList.remove('active');
        }
        
        if (editAppCategoryChartModal) {
             editAppCategoryChartModal.addEventListener('click', function(event) {
                if (event.target === editAppCategoryChartModal) { 
                    closeEditAppCategoryChartModal();
                }
            });
        }


        document.addEventListener('DOMContentLoaded', () => {
            renderAppCategoryChart(); 

            const updateFromModalBtn = document.getElementById('updateAppCategoryChartFromModalBtn');
            if (updateFromModalBtn) {
                updateFromModalBtn.addEventListener('click', () => {
                    const newCategories = [...currentChartData.categories]; 
                    const newCompletedTotal = [];
                    const newNewThisWeek = [];

                    currentChartData.categories.forEach((category, index) => {
                        const prevInput = document.getElementById(`modal-category-${index}-prev`);
                        const newWeekInput = document.getElementById(`modal-category-${index}-new`);
                        
                        const prevVal = parseInt(prevInput.value) || 0;
                        const newWeekVal = parseInt(newWeekInput.value) || 0;

                        newNewThisWeek.push(newWeekVal);
                        newCompletedTotal.push(prevVal + newWeekVal); 
                    });
                    
                    currentChartData.completedTotal = newCompletedTotal;
                    currentChartData.newThisWeek = newNewThisWeek;

                    renderAppCategoryChart(currentChartData); 
                    closeEditAppCategoryChartModal();
                });
            }
        });
    </script>

    <script>
        // Global Chart.js plugin registration
        if (window.Chart && window.ChartDataLabels) {
            Chart.register(ChartDataLabels);
        } else {
            console.error("Chart or ChartDataLabels not available for global registration.");
        }

        // Function to only apply theme classes
        function applyThemeClasses(theme) {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        }

        // Function for updates after theme toggle
        function themeUpdateAndRedraw(newTheme) {
            applyThemeClasses(newTheme); 
            updateButtonIcon(newTheme); 

            requestAnimationFrame(() => { 
                if (typeof drawArchivalCharts === 'function') drawArchivalCharts(); else console.error("drawArchivalCharts not defined for theme update");
                if (typeof renderAppCategoryChart === 'function') renderAppCategoryChart(currentChartData); 
                else console.error("renderAppCategoryChart not defined for theme update");
                
                const cardTypesForThemeUpdate = ['crowd', 'special', 'country', 'operator', 'language'];
                cardTypesForThemeUpdate.forEach(type => {
                    if (typeof updateProgressBar === 'function') updateProgressBar(type); else console.error(`updateProgressBar not defined for theme update of ${type}`);
                });
            });
        }
        
        function toggleTheme() {
            const currentTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            localStorage.setItem('theme', newTheme);
            themeUpdateAndRedraw(newTheme); 
        }
        
        function updateButtonIcon(theme) {
            const sunIcon = document.getElementById('sun-icon');
            const moonIcon = document.getElementById('moon-icon');
            if (sunIcon && moonIcon) {
                if (theme === 'dark') {
                    sunIcon.style.display = 'inline-block';
                    moonIcon.style.display = 'none';
                } else {
                    sunIcon.style.display = 'none';
                    moonIcon.style.display = 'inline-block';
                }
            }
        }

        const progressModal = document.getElementById('progressModal');
        const addProgressForm = document.getElementById('addProgressForm');
        let currentCardTypeForModal = ''; 

        const addCompetitorInsightModal = document.getElementById('addCompetitorInsightModal');
        const addCompetitorInsightForm = document.getElementById('addCompetitorInsightForm');

        let otherInsightsData = {
            crowd: [
                { id: 'crowd_item_1', name: "垂域人群画像分析：英国 ppt (张夙夙)", type: "ppt", status: "inprogress", url: null }
            ],
            special: [
                { id: 'special_item_1', name: "终端厂商AI演进趋势-以Google IO大会为例分析 (杜璐楠)", type: "ppt", status: "completed", url: null },
                { id: 'special_item_2', name: "欧盟数字市场法DMA分析 (杜璐楠)", type: "ppt", status: "completed", url: null },
                { id: 'special_item_3', name: "欧盟数字服务法DSA分析 (杜璐楠)", type: "ppt", status: "completed", url: null },
                { id: 'special_item_4', name: "各手机品牌与Google One的合作", type: "excel", status: "completed", url: null },
                { id: 'special_item_5', name: "Google One特性分析 (杜璐楠)", type: "ppt", status: "completed", url: null },
                { id: 'special_item_6', name: "海外通话语音识别 (杜璐楠)", type: "ppt", status: "completed", url: null },
                { id: 'special_item_7', name: "微软AI功能洞察 (段承欣)", type: "ppt", status: "completed", url: null },
                { id: 'special_item_8', name: "小折输入法海外问卷调研 (张夙夙)", type: "ppt", status: "completed", url: null },
                { id: 'special_item_9', name: "【解决方案洞察】OPPO设备生命周期维护解决方案 (仝瑶瑶)", type: "ppt", status: "completed", url: null },
                { id: 'special_item_10', name: "【解决方案洞察】vivo设备生命周期维护解决方案 (段承欣)", type: "ppt", status: "completed", url: null },
                { id: 'special_item_11', name: "【解决方案洞察】Xiaomi设备生命周期维护解决方案 (牛星星)", type: "ppt", status: "completed", url: null }
            ],
            country: [
                 { id: 'country_item_1', name: "重点国家差异化研究：沙特 ppt (王子欣)", type: "ppt", status: "inprogress", url: null },
                 { id: 'country_item_2', name: "重点国家差异化研究：法国 ppt (张倩)", type: "ppt", status: "inprogress", url: null },
                 { id: 'country_item_3', name: "重点国家差异化研究：马来西亚 ppt (王娟)", type: "ppt", status: "completed", url: null }
            ],
            operator: [], 
            language: [
                 { id: 'language_item_1', name: "全球语言洞察分析 ppt (张夙夙)", type: "ppt", status: "completed", url: null }
            ]
        };


        function openProgressModal(cardType) {
            currentCardTypeForModal = cardType;
            if(document.getElementById('modalTitle')) { 
                document.getElementById('modalTitle').textContent = `为 ${getCardTitle(cardType)} 添加新进度`;
            }
            if(addProgressForm) {
                 addProgressForm.reset(); 
                 const urlInput = document.getElementById('itemUrl'); // Ensure URL input is cleared
                 if (urlInput) urlInput.value = '';
            }
            if(progressModal) progressModal.classList.add('active'); 
        }

        function closeProgressModal() {
            if(progressModal) progressModal.classList.remove('active'); 
        }
        
        function getCardTitle(cardType) { 
            const titles = {
                crowd: '人群洞察', country: '国家洞察',
                operator: '运营商洞察', language: '语言洞察',
                special: '专题洞察'
            };
            return titles[cardType] || '';
        }

        if (addProgressForm) {
            addProgressForm.addEventListener('submit', function(event) {
                event.preventDefault();
                const itemNameInput = document.getElementById('itemName');
                const itemTypeInput = document.getElementById('itemType');
                const itemStatusInput = document.getElementById('itemStatus');
                const itemUrlInput = document.getElementById('itemUrl'); // Get URL input

                if (!itemNameInput || !itemTypeInput || !itemStatusInput || !itemUrlInput) return; 

                const itemName = itemNameInput.value.trim();
                const itemType = itemTypeInput.value;
                const itemStatus = itemStatusInput.value;
                const itemUrl = itemUrlInput.value.trim(); // Get URL value

                if (itemName === '') {
                    showCustomAlert('名称不能为空！');
                    return;
                }
                if (otherInsightsData[currentCardTypeForModal]) {
                    otherInsightsData[currentCardTypeForModal].push({
                        id: 'other_insight_' + Date.now() + Math.random().toString(36).substr(2, 5), 
                        name: itemName,
                        type: itemType,
                        status: itemStatus,
                        url: itemUrl || null // Store URL, or null if empty
                    });
                    renderProgressItems(currentCardTypeForModal); 
                }
                closeProgressModal();
            });
        }
        
        function getNextStatus(currentStatus) {
            if (currentStatus === 'completed') return 'inprogress';
            if (currentStatus === 'inprogress') return 'pending';
            if (currentStatus === 'pending') return 'completed';
            return 'inprogress'; 
        }

        function renderProgressItems(cardType) {
            const progressListContainer = document.getElementById(`progress-list-${cardType}`);
            if (!progressListContainer) {
                console.warn(`Progress list container not found for cardType: ${cardType}`);
                return;
            }
            progressListContainer.innerHTML = ''; 

            const items = otherInsightsData[cardType];

            if (!items || items.length === 0) {
                let noItemText = '暂无洞察';
                if (cardType === 'operator') { 
                     noItemText = '暂无具体进展更新';
                }
                progressListContainer.innerHTML = `<li data-status="none" class="text-base text-slate-500 dark:text-slate-400 italic p-2.5 bg-slate-50 dark:bg-slate-700/60 rounded-lg">${noItemText}</li>`; 
            } else {
                items.forEach(item => {
                    const listItem = document.createElement('li');
                    listItem.className = 'other-insight-progress-item animate-fadeInItem';
                    listItem.setAttribute('data-id', item.id);
                    listItem.setAttribute('data-status', item.status);

                    const textContentContainer = document.createElement('div'); // Container for icon and name/link
                    textContentContainer.className = 'flex items-center truncate mr-2';
                    textContentContainer.style.flexGrow = '1';
                    
                    const typeIconEl = document.createElement('i'); 
                    typeIconEl.className = 'fas mr-2 flex-shrink-0 text-base'; 
                    if (item.type === 'ppt') typeIconEl.classList.add('fa-file-powerpoint', 'text-orange-500');
                    else if (item.type === 'excel') typeIconEl.classList.add('fa-file-excel', 'text-green-500');
                    else typeIconEl.classList.add('fa-file-alt', 'text-gray-500'); 
                    textContentContainer.appendChild(typeIconEl);
                    
                    const nameTextNode = document.createElement('span'); 
                    nameTextNode.className = "truncate text-base text-text-light-primary dark:text-dark-primary"; 
                    nameTextNode.textContent = ` ${item.name}`;

                    if (item.url) {
                        const linkEl = document.createElement('a');
                        linkEl.href = item.url;
                        linkEl.target = "_blank";
                        linkEl.rel = "noopener noreferrer";
                        linkEl.className = "hover:text-primary-light dark:hover:text-primary-dark transition-colors";
                        linkEl.appendChild(nameTextNode);
                        textContentContainer.appendChild(linkEl);
                    } else {
                        textContentContainer.appendChild(nameTextNode);
                    }
                    
                    const statusSpan = document.createElement('span');
                    statusSpan.className = 'insight-item-status status-badge flex-shrink-0'; 
                    
                    function updateStatusBadgeDisplay() {
                        statusSpan.innerHTML = ''; 
                        const statusIcon = document.createElement('i');
                        statusIcon.className = 'fas mr-1.5'; 
                        statusSpan.classList.remove('inprogress', 'completed', 'pending');

                        if (item.status === 'inprogress') {
                            statusSpan.classList.add('inprogress');
                            statusIcon.classList.add('fa-hourglass-half');
                        } else if (item.status === 'completed') {
                            statusSpan.classList.add('completed');
                            statusIcon.classList.add('fa-check-circle');
                        } else if (item.status === 'pending') {
                            statusSpan.classList.add('pending');
                            statusIcon.classList.add('fa-clock'); 
                        }
                        statusSpan.appendChild(statusIcon);
                        statusSpan.appendChild(document.createTextNode(item.status === 'inprogress' ? '进行中' : item.status === 'completed' ? '已完成' : '待开始'));
                    }
                    updateStatusBadgeDisplay();
                    
                    statusSpan.onclick = function() {
                        item.status = getNextStatus(item.status);
                        updateStatusBadgeDisplay(); 
                        updateProgressBar(cardType); 
                    };

                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-insight-btn flex-shrink-0';
                    deleteBtn.innerHTML = '<i class="fas fa-times text-sm"></i>'; 
                    deleteBtn.setAttribute('aria-label', '删除此条目');
                    deleteBtn.onclick = function() {
                        otherInsightsData[cardType] = otherInsightsData[cardType].filter(i => i.id !== item.id);
                        renderProgressItems(cardType); 
                    };

                    listItem.appendChild(textContentContainer); // Add the container for text/link
                    listItem.appendChild(statusSpan);
                    listItem.appendChild(deleteBtn);
                    progressListContainer.appendChild(listItem);
                });
            }
            updateProgressBar(cardType); 
        }
        
        if (progressModal) {
            progressModal.addEventListener('click', function(event) {
                if (event.target === progressModal) closeProgressModal();
            });
        }

        function showCustomAlert(message) {
            if (document.getElementById('customAlertBox')) return;
            const alertBox = document.createElement('div');
            Object.assign(alertBox.style, {
                position: 'fixed', left: '50%', top: '20px', transform: 'translateX(-50%)',
                padding: '1rem 1.5rem', backgroundColor: '#f87171', color: 'white', 
                borderRadius: '0.5rem', boxShadow: '0 4px 6px rgba(0,0,0,0.1)',
                zIndex: '2000', fontSize: '1rem' 
            });
            alertBox.id = 'customAlertBox';
            alertBox.textContent = message;
            document.body.appendChild(alertBox);
            setTimeout(() => {
                alertBox.style.transition = 'opacity 0.5s ease';
                alertBox.style.opacity = '0';
                setTimeout(() => { if (alertBox.parentNode) alertBox.parentNode.removeChild(alertBox);}, 500);
            }, 2500);
        }

        function updateProgressBar(cardType) {
            try {
                const items = otherInsightsData[cardType] || []; 
                let inprogressCount = 0;
                let completedCount = 0;
                let pendingCount = 0;

                items.forEach(item => { 
                    if (item.status === 'inprogress') inprogressCount++;
                    else if (item.status === 'completed') completedCount++;
                    else if (item.status === 'pending') pendingCount++;
                });

                const totalCount = inprogressCount + completedCount + pendingCount;
                const chartContainer = document.getElementById(`progress-chart-${cardType}`);
                if (!chartContainer) {
                    return; 
                }
                
                if (totalCount === 0) {
                     chartContainer.innerHTML = '<p class="text-sm text-text-light-secondary dark:text-dark-secondary italic mt-2 text-center">暂无进度数据</p>'; 
                     const listContainer = document.getElementById(`progress-list-${cardType}`);
                     if(listContainer && listContainer.innerHTML.trim() === '' && cardType === 'operator') {
                        listContainer.innerHTML = `<li id="no-progress-${cardType}" data-status="none" class="text-base text-slate-500 dark:text-slate-400 italic p-2.5 bg-slate-50 dark:bg-slate-700/60 rounded-lg">暂无具体进展更新</li>`; 
                     } else if (listContainer && listContainer.innerHTML.trim() === ''){
                        listContainer.innerHTML = `<li data-status="none" class="text-base text-slate-500 dark:text-slate-400 italic p-2.5 bg-slate-50 dark:bg-slate-700/60 rounded-lg">暂无洞察</li>`; 
                     }
                    return;
                }

                const chartAreaHeight = 80; 
                const inprogressBarHeight = totalCount > 0 ? (inprogressCount / totalCount) * chartAreaHeight : 0;
                const completedBarHeight = totalCount > 0 ? (completedCount / totalCount) * chartAreaHeight : 0;
                const pendingBarHeight = totalCount > 0 ? (pendingCount / totalCount) * chartAreaHeight : 0;

                chartContainer.innerHTML = `
                    <div class="column-chart-container" style="height: ${chartAreaHeight + 40}px;">
                        <div class="chart-column" title="进行中: ${inprogressCount}">
                            <div class="bar status-inprogress-color" style="height: ${Math.max(inprogressBarHeight, inprogressCount > 0 ? 2 : 0)}px;"></div>
                            <span class="bar-label">
                                <span><i class="fas fa-hourglass-half text-status-inprogress mr-1"></i>${inprogressCount}</span>
                                <span class="bar-label-text">进行中</span>
                            </span>
                        </div>
                        <div class="chart-column" title="已完成: ${completedCount}">
                            <div class="bar status-completed-color" style="height: ${Math.max(completedBarHeight, completedCount > 0 ? 2 : 0)}px;"></div>
                             <span class="bar-label">
                                <span><i class="fas fa-check-circle text-status-completed mr-1"></i>${completedCount}</span>
                                <span class="bar-label-text">已完成</span>
                            </span>
                        </div>
                        <div class="chart-column" title="待开始: ${pendingCount}">
                            <div class="bar status-pending-color" style="height: ${Math.max(pendingBarHeight, pendingCount > 0 ? 2 : 0)}px;"></div>
                            <span class="bar-label">
                                <span><i class="fas fa-clock text-status-pending mr-1"></i>${pendingCount}</span>
                                <span class="bar-label-text">待开始</span>
                            </span>
                        </div>
                    </div>
                `;
            } catch (e) {
                console.error(`Error INSIDE updateProgressBar for ${cardType}:`, e.name, e.message, e.stack);
            }
        }

        // --- JS for Competitor Insights "本周新增" ---
        const initialCompetitorInsightsData = [
            { id: 'ci_' + Date.now() + '_1', name: "Android16-Android 16内容速览 ppt 张夙夙", type: "ppt", status: "completed", url: null },
            { id: 'ci_' + Date.now() + '_2', name: "2025-Google IO内容速览 ppt 张夙夙", type: "ppt", status: "inprogress", url: null }
        ];
        let competitorInsightsList = [...initialCompetitorInsightsData];

        function openAddCompetitorInsightModal() {
            if(addCompetitorInsightForm) addCompetitorInsightForm.reset();
            if(addCompetitorInsightModal) addCompetitorInsightModal.classList.add('active');
        }

        function closeAddCompetitorInsightModal() {
            if(addCompetitorInsightModal) addCompetitorInsightModal.classList.remove('active');
        }
        
        function createCompetitorInsightCardElement(insight) {
            const cardDiv = document.createElement('div');
            cardDiv.className = 'insight-list-card p-4 flex flex-col justify-between animate-fadeInItem';  
            cardDiv.setAttribute('data-id', insight.id);
            cardDiv.style.minHeight = '130px'; 

            const mainContentContainer = document.createElement('div');
            mainContentContainer.className = "flex-grow";


            const textSpan = document.createElement('span');
            textSpan.className = 'flex items-start text-base text-text-light-primary dark:text-dark-primary'; 

            const typeIconEl = document.createElement('i'); 
            typeIconEl.className = 'fas mr-2 mt-1 flex-shrink-0 text-base'; 
            if (insight.type === 'ppt') typeIconEl.classList.add('fa-file-powerpoint', 'text-orange-500');
            else if (insight.type === 'excel') typeIconEl.classList.add('fa-file-excel', 'text-green-500');
            else typeIconEl.classList.add('fa-file-alt', 'text-gray-500'); 
            textSpan.appendChild(typeIconEl);
            
            const nameTextNode = document.createElement('span'); 
            nameTextNode.className = "block"; 
            nameTextNode.textContent = insight.name;
            

            if (insight.url) {
                const linkWrapper = document.createElement('a');
                linkWrapper.href = insight.url;
                linkWrapper.target = "_blank";
                linkWrapper.rel = "noopener noreferrer";
                linkWrapper.className = "hover:text-primary-light dark:hover:text-primary-dark transition-colors";
                linkWrapper.appendChild(nameTextNode); // Wrap name in link
                textSpan.appendChild(linkWrapper);
            } else {
                textSpan.appendChild(nameTextNode);
            }
            mainContentContainer.appendChild(textSpan);


            const footerDiv = document.createElement('div');
            footerDiv.className = 'mt-2 pt-2 border-t border-border-light dark:border-border-dark flex items-center justify-between';

            const statusSpan = document.createElement('span');
            statusSpan.className = 'insight-item-status status-badge flex-shrink-0'; 
            
            function updateStatusBadgeDisplay() {
                statusSpan.innerHTML = ''; 
                const statusIcon = document.createElement('i');
                statusIcon.className = 'fas mr-1.5'; 
                statusSpan.classList.remove('inprogress', 'completed', 'pending');

                if (insight.status === 'inprogress') {
                    statusSpan.classList.add('inprogress');
                    statusIcon.classList.add('fa-hourglass-half');
                } else if (insight.status === 'completed') {
                    statusSpan.classList.add('completed');
                    statusIcon.classList.add('fa-check-circle');
                } else if (insight.status === 'pending') {
                    statusSpan.classList.add('pending');
                    statusIcon.classList.add('fa-clock'); 
                }
                statusSpan.appendChild(statusIcon);
                statusSpan.appendChild(document.createTextNode(insight.status === 'inprogress' ? '进行中' : insight.status === 'completed' ? '已完成' : '待开始'));
            }
            updateStatusBadgeDisplay(); 

            statusSpan.onclick = function() {
                const currentInsight = competitorInsightsList.find(item => item.id === insight.id);
                if (currentInsight) {
                    currentInsight.status = getNextStatus(currentInsight.status);
                    updateStatusBadgeDisplay(); 
                }
            };
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-insight-btn flex-shrink-0';
            deleteBtn.innerHTML = '<i class="fas fa-times text-sm"></i>'; 
            deleteBtn.setAttribute('aria-label', '删除此条目');
            deleteBtn.onclick = function() {
                competitorInsightsList = competitorInsightsList.filter(item => item.id !== insight.id);
                renderNewCompetitorInsights();
            };

            footerDiv.appendChild(statusSpan);
            footerDiv.appendChild(deleteBtn);

            cardDiv.appendChild(mainContentContainer);
            cardDiv.appendChild(footerDiv);

            return cardDiv;
        }


        function renderNewCompetitorInsights() {
            const listContainer = document.getElementById('new-competitor-insights-list');
            if (!listContainer) return;
            listContainer.innerHTML = ''; 
            if (competitorInsightsList.length === 0) {
                listContainer.innerHTML = '<p class="col-span-full text-base text-text-light-secondary dark:text-dark-secondary italic text-center py-2">暂无新增洞察</p>'; 
            } else {
                competitorInsightsList.forEach(insight => {
                    listContainer.appendChild(createCompetitorInsightCardElement(insight));
                });
            }
        }
        
        if (addCompetitorInsightForm) {
            addCompetitorInsightForm.addEventListener('submit', function(event) {
                event.preventDefault();
                const nameInput = document.getElementById('competitorInsightName');
                const typeInput = document.getElementById('competitorInsightType');
                const statusInput = document.getElementById('competitorInsightStatus');
                const urlInput = document.getElementById('competitorInsightUrl');


                if (!nameInput || !typeInput || !statusInput || !urlInput) return;

                const name = nameInput.value.trim();
                const type = typeInput.value;
                const status = statusInput.value;
                const url = urlInput.value.trim();


                if (name === '') {
                    showCustomAlert('名称不能为空！');
                    return;
                }
                
                competitorInsightsList.push({ 
                    id: 'ci_' + Date.now() + Math.random().toString(36).substr(2, 5), 
                    name, 
                    type, 
                    status,
                    url: url || null 
                });
                renderNewCompetitorInsights();
                closeAddCompetitorInsightModal();
            });
        }
         if (addCompetitorInsightModal) {
            addCompetitorInsightModal.addEventListener('click', function(event) {
                if (event.target === addCompetitorInsightModal) closeAddCompetitorInsightModal();
            });
        }


        // Consolidated main initialization function
        function initializePageContent() {
            try {
                if (typeof drawArchivalCharts === 'function') drawArchivalCharts(); else console.error("drawArchivalCharts not defined");
                if (typeof renderCompetitorPortfolio === 'function') renderCompetitorPortfolio(); else console.error("renderCompetitorPortfolio not defined");
                if (typeof renderAppTaskRequirements === 'function') renderAppTaskRequirements(); else console.error("renderAppTaskRequirements not defined");
                
                if (typeof renderAppCategoryChart === 'function') renderAppCategoryChart(); else console.error("renderAppCategoryChart not defined"); 
                
                const cardTypesForOtherInsights = ['crowd', 'special', 'country', 'operator', 'language'];
                cardTypesForOtherInsights.forEach(cardType => {
                    if (typeof renderProgressItems === 'function') {
                         renderProgressItems(cardType); 
                    } else {
                         console.error('renderProgressItems function is not defined for cardType:', cardType);
                    }
                });

                if (typeof renderNewCompetitorInsights === 'function') renderNewCompetitorInsights(); else console.error("renderNewCompetitorInsights not defined");


                const currentYearSpan = document.getElementById('currentYear');
                if (currentYearSpan) {
                    currentYearSpan.textContent = new Date().getFullYear();
                }
                
            } catch (error) {
                console.error("ERROR in initializePageContent:", error.name, error.message, error.stack);
            }
        }


        document.addEventListener('DOMContentLoaded', () => {
            const initialTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            applyThemeClasses(initialTheme); 
            updateButtonIcon(initialTheme); 

            const sections = document.querySelectorAll('.fade-in-section');
            const observer = new IntersectionObserver((entries) => {
                entries.forEach((entry) => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('is-visible');
                        observer.unobserve(entry.target);
                    }
                });
            }, { threshold: 0.1 });
            sections.forEach(section => observer.observe(section));
            
            requestAnimationFrame(() => { 
                requestAnimationFrame(() => { 
                    initializePageContent();
                });
            });
        });
    </script>
</body>
</html>
